<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Registration - Official Portal</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --gov-blue: #003366;
            --gov-orange: #ff9933;
        }
        body { font-family: 'Roboto', sans-serif; background-color: #f4f6f9; }
        .top-bar { background-color: #212529; color: white; font-size: 0.85rem; }
        .gov-header { border-bottom: 4px solid var(--gov-orange); background: white; }

        .step-indicator { display: flex; justify-content: space-between; position: relative; margin-bottom: 30px; }
        .step-indicator::before {
            content: ''; position: absolute; top: 15px; left: 0; right: 0;
            height: 2px; background: #e9ecef;
        }
        .step {
            width: 35px; height: 35px;
            background: #fff; border: 2px solid #e9ecef;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: #adb5bd; z-index: 1;
        }
        .step.active { background: var(--gov-blue); border-color: var(--gov-blue); color: white; }
        .step.completed { background: #198754; border-color: #198754; color: white; }

        .form-section { display: none; }
        .form-section.active { display: block; animation: fadeIn .4s ease-in-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .verified-badge {
            display: none;
            color: #198754;
            font-weight: bold;
            font-size: .9rem;
            margin-top: 5px;
        }
    </style>
</head>

<body>

<div class="top-bar py-1">
    <div class="container d-flex justify-content-between">
        <small><i class="fas fa-shield-alt me-1"></i> Official Government Portal</small>
        <a href="{{ url_for('login_official') }}" class="text-white small text-decoration-none">
            <i class="fas fa-sign-in-alt"></i> Official Login
        </a>
    </div>
</div>

<header class="gov-header py-3 shadow-sm">
    <div class="container d-flex justify-content-between align-items-center">
        <div>
            <h5 class="fw-bold mb-0">Organization Onboarding</h5>
            <small class="text-muted">National Cyber Security Division</small>
        </div>
        <a href="{{ url_for('login_official') }}" class="btn btn-outline-dark btn-sm">
            <i class="fas fa-arrow-left"></i> Back
        </a>
    </div>
</header>

<main class="container py-5">
<div class="row justify-content-center">
<div class="col-lg-8">
<div class="card shadow-lg border-0">
<div class="card-header bg-dark text-white">
    <i class="fas fa-lock text-warning"></i> Secure Registration Gateway
</div>

<div class="card-body p-5">

<div class="step-indicator">
    <div class="step active" id="step1">1</div>
    <div class="step" id="step2">2</div>
    <div class="step" id="step3">3</div>
    <div class="step" id="step4">4</div>
</div>

<form id="orgRegForm" enctype="multipart/form-data" onsubmit="handleSubmit(event)">

<!-- ================= STEP 1 ================= -->
<div class="form-section active" id="section1">
<h5 class="fw-bold text-primary mb-4">
<i class="fas fa-landmark"></i> Organization Details
</h5>

<div class="row g-3">

<div class="col-12">
<label class="fw-bold">Organization Name *</label>
<input type="text" name="org_name" class="form-control" required>
</div>

<div class="col-md-6">
<label class="fw-bold">Category *</label>
<select name="category" class="form-select" required>
<option disabled selected>Select Category</option>
<option>PSU</option>
<option>Bank</option>
<option>Government</option>
<option>Critical Infrastructure</option>
</select>
</div>

<div class="col-md-6">
<label class="fw-bold">CIN / Registration No *</label>
<input type="text" name="cin" class="form-control" required>
</div>

<!-- âœ… DOMAIN FIELD ADDED -->
<div class="col-12">
<label class="fw-bold">Official Domain Name *</label>
<div class="input-group">
<input type="text" id="domainInput" name="domain" class="form-control" placeholder="example.gov.in" required>
<button type="button" class="btn btn-outline-primary" id="checkDomainBtn" onclick="checkDomain()">
<i class="fas fa-globe"></i> Verify Domain
</button>
</div>
<div class="verified-badge" id="domainVerifiedBadge">
<i class="fas fa-check-circle"></i> Domain Verified Successfully
</div>
</div>

</div>

<div class="text-end mt-4">
<button type="button" class="btn btn-primary" onclick="nextStep(1)">
Next Step <i class="fas fa-arrow-right"></i>
</button>
</div>
</div>

<!-- ================= STEP 2 ================= -->
<div class="form-section" id="section2">
<h5 class="fw-bold text-primary mb-4">
<i class="fas fa-user-tie"></i> Officer & OTP
</h5>

<div class="row g-3">
<div class="col-12">
<label class="fw-bold">Officer Name *</label>
<input type="text" name="officer_name" class="form-control" required>
</div>

<div class="col-md-6">
<label class="fw-bold">Designation *</label>
<input type="text" name="designation" class="form-control" required>
</div>

<div class="col-md-6">
<label class="fw-bold">Password *</label>
<input type="password" name="password" class="form-control" required>
</div>

<div class="col-12">
<label class="fw-bold">Official Email *</label>
<div class="input-group">
<input type="email" id="emailInput" name="email" class="form-control" required>
<button type="button" class="btn btn-outline-primary" id="sendOtpBtn" onclick="sendOTP()">Send OTP</button>
</div>
<div class="verified-badge" id="emailVerifiedBadge">
<i class="fas fa-check-circle"></i> Email Verified
</div>
</div>

<div class="col-12 d-none" id="otpEntryDiv">
<input type="text" id="otpCode" class="form-control mt-2" maxlength="6">
<button class="btn btn-success mt-2" onclick="verifyOTP()">Verify OTP</button>
</div>
</div>

<div class="d-flex justify-content-between mt-4">
<button class="btn btn-outline-secondary" onclick="prevStep(2)">Previous</button>
<button class="btn btn-primary" onclick="nextStep(2)">Next Step</button>
</div>
</div>

<!-- ================= STEP 3 ================= -->
<div class="form-section" id="section3">
<h5 class="fw-bold text-primary mb-4">
<i class="fas fa-file-upload"></i> Documents
</h5>

<input type="file" name="auth_letter" class="form-control mb-3" required>
<input type="file" name="incorp_cert" class="form-control mb-3" required>

<div class="d-flex justify-content-between">
<button class="btn btn-outline-secondary" onclick="prevStep(3)">Previous</button>
<button class="btn btn-primary" onclick="nextStep(3)">Next Step</button>
</div>
</div>

<!-- ================= STEP 4 ================= -->
<div class="form-section" id="section4">
<h5 class="fw-bold text-success">
<i class="fas fa-check-circle"></i> Submit
</h5>

<input type="checkbox" id="declarationCheck" required>
<label class="fw-bold">I declare all information is true</label>

<div class="d-flex justify-content-between mt-4">
<button class="btn btn-outline-secondary" onclick="prevStep(4)">Previous</button>
<button type="submit" class="btn btn-success" id="finalSubmitBtn">SUBMIT</button>
</div>
</div>

</form>
</div>
</div>
</div>
</div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
let isEmailVerified = false;
let isDomainVerified = false;

/* DOMAIN CHECK */
function checkDomain() {
    const domain = document.getElementById('domainInput').value;
    fetch('/verify-domain', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({domain})
    })
    .then(res => res.json())
    .then(data => {
        if(data.valid){
            isDomainVerified = true;
            document.getElementById('domainInput').readOnly = true;
            document.getElementById('domainVerifiedBadge').style.display = 'block';
            document.getElementById('checkDomainBtn').classList.add('d-none');
        } else {
            alert("Invalid domain name");
        }
    });
}

/* STEP VALIDATION */
function nextStep(current) {
    if(current === 1 && !isDomainVerified){
        alert("Verify domain before proceeding");
        return;
    }
    if(current === 2 && !isEmailVerified){
        alert("Verify email before proceeding");
        return;
    }
    document.getElementById('section'+current).classList.remove('active');
    document.getElementById('section'+(current+1)).classList.add('active');
    document.getElementById('step'+current).classList.add('completed');
    document.getElementById('step'+(current+1)).classList.add('active');
}

function prevStep(current){
    document.getElementById('section'+current).classList.remove('active');
    document.getElementById('section'+(current-1)).classList.add('active');
}

/* REAL OTP LOGIC */
function sendOTP() {
    const email = document.getElementById("emailInput").value;

    if (!email) {
        alert("Enter email first");
        return;
    }

    fetch("/send-otp-org", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            document.getElementById("otpEntryDiv").classList.remove("d-none");
            alert("OTP sent to your email");
        } else {
            alert(data.message || "OTP send failed");
        }
    })
    .catch(() => alert("OTP server error"));
}

function verifyOTP() {
    const otp = document.getElementById("otpCode").value;
    const email = document.getElementById("emailInput").value;

    if (!otp || otp.length !== 6) {
        alert("Enter valid 6-digit OTP");
        return;
    }

    fetch("/verify-otp-org", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, otp })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            isEmailVerified = true; 

            document.getElementById("emailVerifiedBadge").style.display = "block";
            document.getElementById("otpEntryDiv").classList.add("d-none");
            document.getElementById("sendOtpBtn").disabled = true;
            document.getElementById("emailInput").readOnly = true;
        } else {
            alert("Invalid OTP");
        }
    })
    .catch(() => alert("OTP verification failed"));
}

function handleSubmit(e) {
    e.preventDefault();

    const form = document.getElementById("orgRegForm");
    const formData = new FormData(form);
    const btn = document.getElementById("finalSubmitBtn");

    btn.disabled = true;
    btn.innerHTML = "Submitting...";

    fetch("/register-org", {
        method: "POST",
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            showSuccessScreen();
        } else {
            alert(data.error || "Submission failed");
            btn.disabled = false;
            btn.innerHTML = "SUBMIT";
        }
    })
    .catch(() => {
        alert("Server error");
        btn.disabled = false;
        btn.innerHTML = "SUBMIT";
    });
}

/* SUCCESS SCREEN */
function showSuccessScreen() {
    document.querySelector(".card-body").innerHTML = `
        <div class="text-center py-5">
            <i class="fas fa-check-circle text-success" style="font-size:64px;"></i>
            <h3 class="mt-3">Application Submitted</h3>
            <p class="text-muted mt-2">
                Your application has been submitted successfully.<br>
                You will receive an email once the admin approves your organization.
            </p>
            <a href="/" class="btn btn-primary mt-3">
                <i class="fas fa-home"></i> Back to Home
            </a>
        </div>
    `;
}
</script>
</body>
</html>
